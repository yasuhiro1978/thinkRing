# テスト仕様書（Test Specification）
## プロジェクト名：thinkRing
## バージョン：v1.0
## 作成者：yasuhiro

---

# 1. 概要（Overview）

本ドキュメントは、thinkRingアプリケーションのテスト方針とテストケースを定義する。  
品質を確保し、リグレッションを防ぐための包括的なテスト戦略を提供する。

---

# 2. テスト方針（Test Strategy）

## 2.1 テストの種類

### ユニットテスト（Unit Tests）
- **対象**: 個別の関数・メソッド
- **目標カバレッジ**: 80%以上
- **実行頻度**: コミット前、CI/CD

### 統合テスト（Integration Tests）
- **対象**: APIエンドポイント、データベース連携
- **目標カバレッジ**: 主要機能100%
- **実行頻度**: プルリクエスト時、CI/CD

### E2Eテスト（End-to-End Tests）
- **対象**: ユーザーシナリオ全体
- **目標カバレッジ**: 主要フロー100%
- **実行頻度**: デプロイ前

## 2.2 テストピラミッド

```
        /\
       /  \  E2E Tests (10%)
      /____\
     /      \  Integration Tests (30%)
    /________\
   /          \  Unit Tests (60%)
  /____________\
```

---

# 3. バックエンドテスト

## 3.1 テストフレームワーク

- **Django**: `django.test.TestCase`
- **API**: `rest_framework.test.APIClient`
- **モック**: `unittest.mock`

## 3.2 テスト構造

```
backend/
  apps/
    projects/
      tests/
        __init__.py
        test_models.py
        test_views.py
        test_serializers.py
        test_utils.py
```

## 3.3 モデルテスト

### プロジェクトモデル

```python
# backend/apps/projects/tests/test_models.py
from django.test import TestCase
from apps.projects.models import Project

class ProjectModelTest(TestCase):
    def setUp(self):
        self.project = Project.objects.create(
            title="テストプロジェクト",
            status="active"
        )
    
    def test_project_creation(self):
        self.assertEqual(self.project.title, "テストプロジェクト")
        self.assertEqual(self.project.status, "active")
    
    def test_project_str(self):
        self.assertEqual(str(self.project), "テストプロジェクト")
```

## 3.4 APIテスト

### プロジェクト作成API

```python
# backend/apps/projects/tests/test_views.py
from rest_framework.test import APIClient
from rest_framework import status
from django.contrib.auth import get_user_model

User = get_user_model()

class ProjectAPITest(TestCase):
    def setUp(self):
        self.client = APIClient()
        self.user = User.objects.create_user(
            username='testuser',
            password='testpass123'
        )
        self.client.force_authenticate(user=self.user)
    
    def test_create_project(self):
        data = {
            'title': '新規プロジェクト',
            'status': 'active'
        }
        response = self.client.post('/api/v1/projects/', data)
        self.assertEqual(response.status_code, status.HTTP_201_CREATED)
        self.assertEqual(Project.objects.count(), 1)
    
    def test_get_project_list(self):
        Project.objects.create(title='プロジェクト1', user=self.user)
        Project.objects.create(title='プロジェクト2', user=self.user)
        
        response = self.client.get('/api/v1/projects/')
        self.assertEqual(response.status_code, status.HTTP_200_OK)
        self.assertEqual(len(response.data), 2)
    
    def test_get_project_detail(self):
        project = Project.objects.create(
            title='テストプロジェクト',
            user=self.user
        )
        response = self.client.get(f'/api/v1/projects/{project.id}/')
        self.assertEqual(response.status_code, status.HTTP_200_OK)
        self.assertEqual(response.data['title'], 'テストプロジェクト')
    
    def test_update_project(self):
        project = Project.objects.create(
            title='テストプロジェクト',
            user=self.user
        )
        data = {'title': '更新されたプロジェクト'}
        response = self.client.put(
            f'/api/v1/projects/{project.id}/',
            data
        )
        self.assertEqual(response.status_code, status.HTTP_200_OK)
        project.refresh_from_db()
        self.assertEqual(project.title, '更新されたプロジェクト')
    
    def test_delete_project(self):
        project = Project.objects.create(
            title='テストプロジェクト',
            user=self.user
        )
        response = self.client.delete(f'/api/v1/projects/{project.id}/')
        self.assertEqual(response.status_code, status.HTTP_204_NO_CONTENT)
        self.assertEqual(Project.objects.count(), 0)
```

### 認証テスト

```python
# backend/apps/auth/tests/test_authentication.py
class AuthenticationTest(TestCase):
    def test_login_success(self):
        User.objects.create_user(
            username='testuser',
            password='testpass123'
        )
        data = {
            'username': 'testuser',
            'password': 'testpass123'
        }
        response = self.client.post('/api/v1/auth/login/', data)
        self.assertEqual(response.status_code, status.HTTP_200_OK)
        self.assertIn('access', response.data)
    
    def test_login_failure(self):
        data = {
            'username': 'testuser',
            'password': 'wrongpassword'
        }
        response = self.client.post('/api/v1/auth/login/', data)
        self.assertEqual(response.status_code, status.HTTP_401_UNAUTHORIZED)
```

## 3.5 バリデーションテスト

```python
# backend/apps/projects/tests/test_serializers.py
class ProjectSerializerTest(TestCase):
    def test_serializer_valid_data(self):
        data = {
            'title': 'テストプロジェクト',
            'status': 'active'
        }
        serializer = ProjectSerializer(data=data)
        self.assertTrue(serializer.is_valid())
    
    def test_serializer_invalid_data(self):
        data = {
            'title': '',  # 空文字は無効
            'status': 'active'
        }
        serializer = ProjectSerializer(data=data)
        self.assertFalse(serializer.is_valid())
```

---

# 4. フロントエンドテスト

## 4.1 テストフレームワーク

- **Svelte**: `@testing-library/svelte`
- **React**: `@testing-library/react`
- **E2E**: Playwright / Cypress

## 4.2 コンポーネントテスト

### プロジェクト作成フォーム（Svelte例）

```typescript
// frontend/src/components/ProjectForm.test.ts
import { render, screen, fireEvent } from '@testing-library/svelte';
import ProjectForm from './ProjectForm.svelte';

describe('ProjectForm', () => {
  it('renders form fields', () => {
    render(ProjectForm);
    expect(screen.getByLabelText('プロジェクト名')).toBeInTheDocument();
    expect(screen.getByRole('button', { name: '作成' })).toBeInTheDocument();
  });
  
  it('submits form with valid data', async () => {
    const { component } = render(ProjectForm);
    const titleInput = screen.getByLabelText('プロジェクト名');
    const submitButton = screen.getByRole('button', { name: '作成' });
    
    await fireEvent.input(titleInput, { target: { value: '新規プロジェクト' } });
    await fireEvent.click(submitButton);
    
    // イベントの確認
    expect(component.$$.ctx[0]).toHaveBeenCalled();
  });
  
  it('shows validation error for empty title', async () => {
    render(ProjectForm);
    const submitButton = screen.getByRole('button', { name: '作成' });
    
    await fireEvent.click(submitButton);
    
    expect(screen.getByText('プロジェクト名は必須です')).toBeInTheDocument();
  });
});
```

## 4.3 API呼び出しテスト

```typescript
// frontend/src/services/api.test.ts
import { fetchProjects, createProject } from './api';
import { server } from '../mocks/server';

describe('API Service', () => {
  it('fetches projects', async () => {
    const projects = await fetchProjects();
    expect(projects).toHaveLength(2);
    expect(projects[0].title).toBe('プロジェクト1');
  });
  
  it('creates a project', async () => {
    const newProject = await createProject({
      title: '新規プロジェクト',
      status: 'active'
    });
    expect(newProject.title).toBe('新規プロジェクト');
  });
});
```

---

# 5. E2Eテスト

## 5.1 Playwright設定

```typescript
// e2e/playwright.config.ts
import { defineConfig } from '@playwright/test';

export default defineConfig({
  testDir: './tests',
  use: {
    baseURL: 'http://localhost:3000',
    screenshot: 'only-on-failure',
  },
  projects: [
    {
      name: 'chromium',
      use: { ...devices['Desktop Chrome'] },
    },
  ],
});
```

## 5.2 E2Eテストケース

### プロジェクト作成フロー

```typescript
// e2e/tests/project-creation.spec.ts
import { test, expect } from '@playwright/test';

test('プロジェクトを作成できる', async ({ page }) => {
  // ログイン
  await page.goto('/login');
  await page.fill('input[name="username"]', 'testuser');
  await page.fill('input[name="password"]', 'testpass123');
  await page.click('button[type="submit"]');
  
  // ホーム画面に遷移
  await expect(page).toHaveURL('/');
  
  // プロジェクト作成ボタンをクリック
  await page.click('text=新規プロジェクト作成');
  
  // フォームに入力
  await page.fill('input[name="title"]', 'E2Eテストプロジェクト');
  await page.click('button:has-text("作成")');
  
  // プロジェクト一覧に表示されることを確認
  await expect(page.locator('text=E2Eテストプロジェクト')).toBeVisible();
});
```

### 思考プロセス入力フロー

```typescript
// e2e/tests/thinking-process.spec.ts
test('思考プロセスの5ステップを入力できる', async ({ page }) => {
  // プロジェクトを開く
  await page.goto('/projects/1');
  
  // 1周目を開始
  await page.click('text=1周目を開始');
  
  // 俯瞰ステージ
  await page.fill('textarea[name="overview"]', 'テストの俯瞰');
  await page.click('text=次へ');
  
  // 要素抽出ステージ
  await page.fill('textarea[name="extract"]', 'テストの要素');
  await page.click('text=次へ');
  
  // 流れ構築ステージ
  await page.fill('textarea[name="flow"]', 'テストの流れ');
  await page.click('text=次へ');
  
  // 最小仕様ステージ
  await page.fill('textarea[name="mvp"]', 'テストのMVP');
  await page.click('text=次へ');
  
  // 拡張余地ステージ
  await page.fill('textarea[name="expand"]', 'テストの拡張');
  await page.click('text=完了');
  
  // 完了画面が表示されることを確認
  await expect(page.locator('text=1周目が完了しました')).toBeVisible();
});
```

---

# 6. テストデータ管理

## 6.1 フィクスチャ

```python
# backend/apps/projects/fixtures/test_data.json
[
  {
    "model": "projects.project",
    "pk": 1,
    "fields": {
      "title": "テストプロジェクト1",
      "status": "active",
      "created_at": "2024-01-01T00:00:00Z"
    }
  }
]
```

## 6.2 ファクトリー

```python
# backend/apps/projects/factories.py
import factory
from apps.projects.models import Project

class ProjectFactory(factory.django.DjangoModelFactory):
    class Meta:
        model = Project
    
    title = factory.Sequence(lambda n: f'プロジェクト{n}')
    status = 'active'
```

---

# 7. テストカバレッジ

## 7.1 カバレッジ測定

### バックエンド

```bash
# カバレッジの実行
coverage run --source='.' manage.py test
coverage report
coverage html
```

### フロントエンド

```bash
# カバレッジの実行
npm run test:coverage
```

## 7.2 カバレッジ目標

- **ユニットテスト**: 80%以上
- **統合テスト**: 主要機能100%
- **E2Eテスト**: 主要フロー100%

---

# 8. テスト実行

## 8.1 ローカル実行

### バックエンド

```bash
# 全テスト実行
python manage.py test

# 特定のアプリのテスト
python manage.py test apps.projects

# 特定のテストクラス
python manage.py test apps.projects.tests.test_views.ProjectAPITest
```

### フロントエンド

```bash
# 全テスト実行
npm test

# ウォッチモード
npm run test:watch

# カバレッジ付き
npm run test:coverage
```

### E2E

```bash
# 全E2Eテスト実行
npx playwright test

# 特定のテスト
npx playwright test project-creation
```

## 8.2 CI/CD実行

```yaml
# .github/workflows/test.yml
name: Tests

on: [push, pull_request]

jobs:
  backend-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Run tests
        run: |
          docker-compose run backend python manage.py test
  
  frontend-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Run tests
        run: |
          docker-compose run frontend npm test
  
  e2e-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Run E2E tests
        run: |
          docker-compose up -d
          npx playwright test
```

---

# 9. 主要機能のテストケース

## 9.1 プロジェクト管理

| テストケース | 種類 | 優先度 |
|------------|------|--------|
| プロジェクト作成 | 統合 | 高 |
| プロジェクト一覧取得 | 統合 | 高 |
| プロジェクト詳細取得 | 統合 | 高 |
| プロジェクト更新 | 統合 | 高 |
| プロジェクト削除 | 統合 | 高 |
| プロジェクト名の重複チェック | ユニット | 中 |

## 9.2 思考プロセス

| テストケース | 種類 | 優先度 |
|------------|------|--------|
| 1周目の5ステップ入力 | E2E | 高 |
| ステップの保存 | 統合 | 高 |
| ステップの取得 | 統合 | 高 |
| ステップの更新 | 統合 | 中 |

## 9.3 ノード管理

| テストケース | 種類 | 優先度 |
|------------|------|--------|
| ノード作成 | 統合 | 高 |
| ノード一覧取得 | 統合 | 高 |
| ノード詳細取得 | 統合 | 高 |
| グローバルノード作成 | 統合 | 中 |
| ノード更新 | 統合 | 中 |
| ノード削除 | 統合 | 中 |

## 9.4 認証

| テストケース | 種類 | 優先度 |
|------------|------|--------|
| ログイン成功 | 統合 | 高 |
| ログイン失敗 | 統合 | 高 |
| トークンリフレッシュ | 統合 | 高 |
| ログアウト | 統合 | 中 |
| 認証が必要なAPIの保護 | 統合 | 高 |

---

# 10. パフォーマンステスト

## 10.1 負荷テスト

```python
# backend/apps/projects/tests/test_performance.py
from django.test import TestCase
import time

class PerformanceTest(TestCase):
    def test_project_list_performance(self):
        # 大量のプロジェクトを作成
        for i in range(100):
            Project.objects.create(title=f'プロジェクト{i}')
        
        start_time = time.time()
        response = self.client.get('/api/v1/projects/')
        end_time = time.time()
        
        # 1秒以内にレスポンスが返ることを確認
        self.assertLess(end_time - start_time, 1.0)
```

---

# 11. セキュリティテスト

## 11.1 SQLインジェクションテスト

```python
def test_sql_injection_protection(self):
    malicious_input = "'; DROP TABLE projects; --"
    response = self.client.post('/api/v1/projects/', {
        'title': malicious_input
    })
    # エラーが返るか、サニタイズされることを確認
    self.assertNotEqual(response.status_code, 500)
```

## 11.2 XSSテスト

```python
def test_xss_protection(self):
    malicious_input = "<script>alert('XSS')</script>"
    response = self.client.post('/api/v1/projects/', {
        'title': malicious_input
    })
    # HTMLがエスケープされることを確認
    self.assertNotIn('<script>', response.data['title'])
```

---

# 12. テストメンテナンス

## 12.1 テストの更新

- 機能追加時はテストも追加
- リファクタリング時はテストを更新
- バグ修正時は回帰テストを追加

## 12.2 テストの削除

- 不要になったテストは削除
- 重複するテストは統合

---

# 13. テストチェックリスト

## 13.1 開発時

- [ ] 新機能にはテストを追加
- [ ] バグ修正には回帰テストを追加
- [ ] テストが通ることを確認
- [ ] カバレッジ目標を達成

## 13.2 プルリクエスト時

- [ ] すべてのテストが通る
- [ ] カバレッジが下がっていない
- [ ] E2Eテストが通る

## 13.3 デプロイ前

- [ ] 全テストスイートが通る
- [ ] パフォーマンステストが通る
- [ ] セキュリティテストが通る

---

# 14. 備考

- 本仕様は MVP 版を前提とする
- テストケースは段階的に追加
- カバレッジ目標は定期的に見直し

