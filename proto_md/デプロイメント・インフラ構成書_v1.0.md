# デプロイメント・インフラ構成書（Deployment & Infrastructure Specification）
## プロジェクト名：thinkRing
## バージョン：v1.0
## 作成者：yasuhiro

---

# 1. 概要（Overview）

本ドキュメントは、thinkRingアプリケーションのデプロイメントとインフラ構成を定義する。  
Dockerを使用したコンテナベースのデプロイメントを前提とする。

---

# 2. インフラ構成

## 2.1 全体構成図

```
┌─────────────────────────────────────────┐
│          ユーザー（ブラウザ）              │
└──────────────────┬──────────────────────┘
                   │ HTTPS
                   ▼
┌─────────────────────────────────────────┐
│         Nginx（リバースプロキシ）         │
│  - SSL/TLS終端                          │
│  - 静的ファイル配信                      │
│  - ロードバランシング（将来）             │
└──────┬──────────────────┬────────────────┘
       │                  │
       │ HTTP             │ HTTP
       ▼                  ▼
┌─────────────┐    ┌─────────────┐
│  Frontend   │    │  Backend    │
│  Container  │    │  Container  │
│  (Svelte)   │    │  (Django)   │
└─────────────┘    └──────┬──────┘
                          │
                          │ SQL
                          ▼
                   ┌─────────────┐
                   │  Database   │
                   │  Container  │
                   │ (PostgreSQL)│
                   └─────────────┘
```

## 2.2 コンテナ構成

| サービス | イメージ | ポート | 説明 |
|---------|---------|--------|------|
| nginx | nginx:alpine | 80, 443 | リバースプロキシ |
| frontend | node:18-alpine | 3000 | フロントエンド |
| backend | python:3.10-slim | 8000 | バックエンドAPI |
| db | postgres:15 | 5432 | データベース |

---

# 3. Docker Compose構成

## 3.1 本番環境用docker-compose.yml

```yaml
version: '3.8'

services:
  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro
      - static_files:/var/www/static
    depends_on:
      - frontend
      - backend
    restart: always

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile.prod
    environment:
      - VITE_API_BASE_URL=https://api.thinkring.example.com/api/v1
    volumes:
      - static_files:/app/dist
    restart: always

  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile.prod
    environment:
      - DEBUG=False
      - SECRET_KEY=${SECRET_KEY}
      - DB_NAME=${DB_NAME}
      - DB_USER=${DB_USER}
      - DB_PASSWORD=${DB_PASSWORD}
      - DB_HOST=db
      - DB_PORT=5432
    volumes:
      - static_files:/app/staticfiles
      - media_files:/app/media
    depends_on:
      - db
    restart: always

  db:
    image: postgres:15
    environment:
      - POSTGRES_DB=${DB_NAME}
      - POSTGRES_USER=${DB_USER}
      - POSTGRES_PASSWORD=${DB_PASSWORD}
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./backups:/backups
    restart: always

volumes:
  postgres_data:
  static_files:
  media_files:
```

## 3.2 環境変数ファイル（.env.production）

```bash
# Django設定
SECRET_KEY=your-production-secret-key
DEBUG=False
ALLOWED_HOSTS=thinkring.example.com,api.thinkring.example.com

# データベース設定
DB_NAME=thinkring_prod
DB_USER=thinkring_user
DB_PASSWORD=secure-password-here
DB_HOST=db
DB_PORT=5432

# JWT設定
JWT_SECRET_KEY=your-jwt-secret-key
JWT_ACCESS_TOKEN_LIFETIME=15
JWT_REFRESH_TOKEN_LIFETIME=7

# CORS設定
CORS_ALLOWED_ORIGINS=https://thinkring.example.com
```

---

# 4. Nginx設定

## 4.1 nginx.conf

```nginx
upstream backend {
    server backend:8000;
}

upstream frontend {
    server frontend:3000;
}

server {
    listen 80;
    server_name thinkring.example.com;
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name thinkring.example.com;

    ssl_certificate /etc/nginx/ssl/cert.pem;
    ssl_certificate_key /etc/nginx/ssl/key.pem;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;

    # セキュリティヘッダー
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
    add_header X-Frame-Options "DENY" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;

    # 静的ファイル
    location /static/ {
        alias /var/www/static/;
        expires 30d;
        add_header Cache-Control "public, immutable";
    }

    # メディアファイル
    location /media/ {
        alias /app/media/;
        expires 7d;
    }

    # API
    location /api/ {
        proxy_pass http://backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # フロントエンド
    location / {
        proxy_pass http://frontend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

---

# 5. デプロイメント手順

## 5.1 初回デプロイメント

```bash
# 1. リポジトリのクローン
git clone https://github.com/your-org/thinkring.git
cd thinkring

# 2. 環境変数の設定
cp .env.production.example .env.production
# .env.production を編集して適切な値を設定

# 3. SSL証明書の配置
mkdir -p nginx/ssl
# Let's Encrypt で証明書を取得
certbot certonly --standalone -d thinkring.example.com
cp /etc/letsencrypt/live/thinkring.example.com/fullchain.pem nginx/ssl/cert.pem
cp /etc/letsencrypt/live/thinkring.example.com/privkey.pem nginx/ssl/key.pem

# 4. コンテナのビルドと起動
docker-compose -f docker-compose.prod.yml up -d --build

# 5. データベースマイグレーション
docker-compose -f docker-compose.prod.yml exec backend python manage.py migrate

# 6. 静的ファイルの収集
docker-compose -f docker-compose.prod.yml exec backend python manage.py collectstatic --noinput

# 7. スーパーユーザーの作成
docker-compose -f docker-compose.prod.yml exec backend python manage.py createsuperuser
```

## 5.2 更新デプロイメント

```bash
# 1. 最新のコードを取得
git pull origin main

# 2. コンテナの再ビルドと再起動
docker-compose -f docker-compose.prod.yml up -d --build

# 3. マイグレーションの実行（必要に応じて）
docker-compose -f docker-compose.prod.yml exec backend python manage.py migrate

# 4. 静的ファイルの再収集（必要に応じて）
docker-compose -f docker-compose.prod.yml exec backend python manage.py collectstatic --noinput
```

---

# 6. CI/CDパイプライン

## 6.1 GitHub Actions設定（.github/workflows/deploy.yml）

```yaml
name: Deploy to Production

on:
  push:
    branches:
      - main

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: Install dependencies
        run: |
          cd backend
          pip install -r requirements.txt
      
      - name: Run tests
        run: |
          cd backend
          python manage.py test

  build-and-deploy:
    needs: test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Deploy to server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            cd /path/to/thinkring
            git pull origin main
            docker-compose -f docker-compose.prod.yml up -d --build
            docker-compose -f docker-compose.prod.yml exec backend python manage.py migrate
            docker-compose -f docker-compose.prod.yml exec backend python manage.py collectstatic --noinput
```

## 6.2 デプロイメントフロー

```
1. コードをmainブランチにプッシュ
   ↓
2. GitHub Actionsがテストを実行
   ↓
3. テスト成功後、本番サーバーにSSH接続
   ↓
4. 最新のコードを取得
   ↓
5. Dockerコンテナを再ビルド・再起動
   ↓
6. マイグレーションと静的ファイル収集
   ↓
7. デプロイメント完了
```

---

# 7. バックアップ戦略

## 7.1 データベースバックアップ

### 自動バックアップスクリプト

```bash
#!/bin/bash
# backup.sh

BACKUP_DIR="/backups"
DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_FILE="$BACKUP_DIR/thinkring_db_$DATE.sql"

docker-compose exec -T db pg_dump -U thinkring_user thinkring_prod > $BACKUP_FILE

# 7日以上古いバックアップを削除
find $BACKUP_DIR -name "thinkring_db_*.sql" -mtime +7 -delete
```

### 定期バックアップ設定（cron）

```bash
# 毎日午前2時にバックアップ
0 2 * * * /path/to/backup.sh
```

## 7.2 バックアップの復元

```bash
# バックアップファイルから復元
docker-compose exec -T db psql -U thinkring_user thinkring_prod < /backups/thinkring_db_20240101_020000.sql
```

---

# 8. モニタリング

## 8.1 ログ管理

### ログの確認

```bash
# 全コンテナのログ
docker-compose logs

# 特定のコンテナのログ
docker-compose logs backend
docker-compose logs frontend
docker-compose logs nginx

# リアルタイムログ
docker-compose logs -f backend
```

### ログローテーション

```bash
# Dockerのログドライバー設定
# docker-compose.yml に追加
logging:
  driver: "json-file"
  options:
    max-size: "10m"
    max-file: "3"
```

## 8.2 ヘルスチェック

### ヘルスチェックエンドポイント

```python
# backend/apps/core/views.py
from django.http import JsonResponse

def health_check(request):
    return JsonResponse({"status": "healthy"})
```

### 定期的なヘルスチェック

```bash
# ヘルスチェックスクリプト
#!/bin/bash
response=$(curl -s -o /dev/null -w "%{http_code}" https://thinkring.example.com/api/v1/health/)
if [ $response != "200" ]; then
    # アラート送信
    echo "Health check failed: $response"
fi
```

---

# 9. スケーリング戦略

## 9.1 水平スケーリング（将来）

### ロードバランサー設定

```nginx
upstream backend {
    least_conn;
    server backend1:8000;
    server backend2:8000;
    server backend3:8000;
}
```

### Docker Swarm / Kubernetes（将来）

- コンテナの自動スケーリング
- ロードバランシング
- 高可用性

---

# 10. セキュリティ対策

## 10.1 ファイアウォール設定

```bash
# 必要なポートのみ開放
ufw allow 80/tcp
ufw allow 443/tcp
ufw allow 22/tcp  # SSH
ufw enable
```

## 10.2 SSL証明書の自動更新

```bash
# Let's Encrypt証明書の自動更新
0 0 1 * * certbot renew --quiet --deploy-hook "docker-compose restart nginx"
```

## 10.3 セキュリティアップデート

```bash
# 定期的なコンテナイメージの更新
docker-compose pull
docker-compose up -d --build
```

---

# 11. パフォーマンス最適化

## 11.1 キャッシュ戦略

- 静的ファイル: Nginxでキャッシュ
- APIレスポンス: Redisキャッシュ（将来）

## 11.2 CDN（将来）

- 静的ファイルをCDNに配信
- 画像の最適化

---

# 12. 災害復旧計画

## 12.1 復旧手順

1. バックアップからのデータベース復元
2. コンテナの再起動
3. 動作確認

## 12.2 RTO/RPO目標

- **RTO（Recovery Time Objective）**: 4時間以内
- **RPO（Recovery Point Objective）**: 24時間以内

---

# 13. 環境別設定

## 13.1 開発環境

- `docker-compose.yml` を使用
- デバッグモード有効
- ホットリロード有効

## 13.2 ステージング環境

- 本番環境と同様の構成
- テストデータを使用
- デバッグモード無効

## 13.3 本番環境

- `docker-compose.prod.yml` を使用
- デバッグモード無効
- 最適化されたビルド

---

# 14. トラブルシューティング

## 14.1 よくある問題

### コンテナが起動しない

```bash
# ログを確認
docker-compose logs

# コンテナの状態確認
docker-compose ps

# 完全にクリーンアップ
docker-compose down -v
docker-compose up -d --build
```

### データベース接続エラー

```bash
# データベースコンテナの確認
docker-compose ps db

# データベースログの確認
docker-compose logs db

# 環境変数の確認
docker-compose exec backend env | grep DB
```

---

# 15. 備考

- 本構成は MVP 版を前提とする
- 将来的な拡張（Kubernetes、CDN等）を考慮
- セキュリティとパフォーマンスは定期的に見直し

