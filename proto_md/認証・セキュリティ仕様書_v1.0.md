# 認証・セキュリティ仕様書（Authentication & Security Specification）
## プロジェクト名：thinkRing
## バージョン：v1.0
## 作成者：yasuhiro

---

# 1. 概要（Overview）

本ドキュメントは、thinkRingアプリケーションの認証方式とセキュリティ要件を定義する。  
初期リリースでは個人利用を前提とするが、将来的な拡張（チーム共有等）を考慮した設計とする。

---

# 2. 認証方式（Authentication Method）

## 2.1 認証方式の選定

### 採用方式
**JWT（JSON Web Token）**

### 選定理由
- ステートレスでスケーラブル
- モバイルアプリ対応が容易
- Django REST Framework との相性が良い
- トークンの有効期限管理が容易

### 代替案（将来検討）
- Session認証（Webアプリのみの場合）
- OAuth 2.0（外部サービス連携時）

---

## 2.2 JWT実装詳細

### 2.2.1 トークン構造

#### Access Token（アクセストークン）
- **有効期限**: 15分
- **用途**: APIリクエスト時の認証
- **保存場所**: メモリ（JavaScript変数）
- **送信方法**: HTTPヘッダー `Authorization: Bearer {token}`

#### Refresh Token（リフレッシュトークン）
- **有効期限**: 7日
- **用途**: Access Tokenの更新
- **保存場所**: HttpOnly Cookie（XSS対策）
- **送信方法**: Cookie

### 2.2.2 トークンペイロード

```json
{
  "user_id": "uuid",
  "username": "string",
  "exp": 1234567890,
  "iat": 1234567890,
  "token_type": "access"
}
```

### 2.2.3 トークン生成・検証

#### 生成
- アルゴリズム: HS256
- シークレットキー: 環境変数から取得
- 発行元: Django REST Framework JWT

#### 検証
- 有効期限チェック
- 署名検証
- ユーザー存在確認

---

## 2.3 認証フロー

### 2.3.1 ログイン

```
1. ユーザーがログイン情報を送信
   POST /api/v1/auth/login/
   {
     "username": "user",
     "password": "password"
   }

2. サーバーが認証を確認

3. サーバーがAccess TokenとRefresh Tokenを発行
   Response:
   {
     "access": "eyJ0eXAiOiJKV1QiLCJhbGc...",
     "refresh": "eyJ0eXAiOiJKV1QiLCJhbGc..."
   }

4. クライアントがAccess Tokenをメモリに保存
5. クライアントがRefresh TokenをCookieに保存
```

### 2.3.2 トークンリフレッシュ

```
1. Access Tokenの有効期限が切れる
2. クライアントがRefresh Tokenを送信
   POST /api/v1/auth/refresh/
   Cookie: refresh_token=...

3. サーバーが新しいAccess Tokenを発行
   Response:
   {
     "access": "eyJ0eXAiOiJKV1QiLCJhbGc..."
   }
```

### 2.3.3 ログアウト

```
1. クライアントがログアウトリクエストを送信
   POST /api/v1/auth/logout/

2. サーバーがRefresh Tokenを無効化（ブラックリストに追加）

3. クライアントがメモリとCookieからトークンを削除
```

---

# 3. セキュリティ要件（Security Requirements）

## 3.1 HTTPS

### 要件
- **本番環境**: HTTPS必須
- **開発環境**: ローカル開発時のみHTTP許可

### 実装
- Nginxでリバースプロキシ
- Let's EncryptでSSL証明書取得
- HTTPリクエストはHTTPSにリダイレクト

---

## 3.2 CSRF対策（Cross-Site Request Forgery）

### 要件
- Django標準のCSRF保護を有効化
- APIリクエストではCSRFトークン不要（JWT認証を使用）

### 実装
```python
# settings.py
CSRF_COOKIE_SECURE = True  # HTTPS時のみ
CSRF_COOKIE_HTTPONLY = True
CSRF_TRUSTED_ORIGINS = ['https://thinkring.example.com']
```

### 例外
- JWT認証を使用するAPIエンドポイントはCSRF除外

---

## 3.3 XSS対策（Cross-Site Scripting）

### 要件
- ユーザー入力のサニタイズ
- Content Security Policy（CSP）の設定

### 実装
- Djangoのテンプレートエスケープ機能を使用
- React/Svelteの自動エスケープ機能を使用
- CSPヘッダーの設定

```python
# settings.py
SECURE_CONTENT_TYPE_NOSNIFF = True
SECURE_BROWSER_XSS_FILTER = True
X_FRAME_OPTIONS = 'DENY'
```

---

## 3.4 SQLインジェクション対策

### 要件
- ORMを使用したクエリのみ許可
- 生SQLは原則禁止

### 実装
- Django ORMを使用
- パラメータ化クエリを強制
- 入力値のバリデーション

---

## 3.5 パスワード管理

### 要件
- パスワードはハッシュ化して保存
- 最小長: 8文字
- 複雑さ要件: 大文字・小文字・数字を含む（推奨）

### 実装
- Django標準の `PBKDF2PasswordHasher` を使用
- パスワードリセット機能（将来実装）

---

## 3.6 レート制限（Rate Limiting）

### 要件
- ログイン試行: 5回/分
- APIリクエスト: 100回/分/ユーザー

### 実装
- Django REST Framework の `throttling` を使用
- IPアドレスベースの制限

```python
# settings.py
REST_FRAMEWORK = {
    'DEFAULT_THROTTLE_CLASSES': [
        'rest_framework.throttling.UserRateThrottle',
        'rest_framework.throttling.AnonRateThrottle',
    ],
    'DEFAULT_THROTTLE_RATES': {
        'user': '100/minute',
        'anon': '20/minute',
    }
}
```

---

# 4. 権限管理（Authorization）

## 4.1 権限モデル（MVP版）

### 現状
- MVPでは個人利用のみ
- ユーザーは自分のデータのみアクセス可能

### 将来拡張
- チーム共有機能
- ロールベースアクセス制御（RBAC）
  - Owner（所有者）
  - Editor（編集者）
  - Viewer（閲覧者）

---

## 4.2 データアクセス制御

### 実装方針
- 各リクエストでユーザーIDを確認
- データ取得時にユーザーIDでフィルタリング

```python
# 例: プロジェクト取得
def get_queryset(self):
    return Project.objects.filter(user_id=self.request.user.id)
```

---

# 5. CORS設定（Cross-Origin Resource Sharing）

## 5.1 要件

### 開発環境
- ローカル開発サーバー（localhost:3000等）からのアクセスを許可

### 本番環境
- 許可するオリジンのみアクセス可能

## 5.2 実装

```python
# settings.py
CORS_ALLOWED_ORIGINS = [
    "https://thinkring.example.com",
    "https://app.thinkring.example.com",
]

# 開発環境
if DEBUG:
    CORS_ALLOWED_ORIGINS += [
        "http://localhost:3000",
        "http://127.0.0.1:3000",
    ]

CORS_ALLOW_CREDENTIALS = True
CORS_ALLOW_HEADERS = [
    'accept',
    'accept-encoding',
    'authorization',
    'content-type',
    'dnt',
    'origin',
    'user-agent',
    'x-csrftoken',
    'x-requested-with',
]
```

---

# 6. セキュリティヘッダー

## 6.1 設定するヘッダー

```python
# settings.py
SECURE_SSL_REDIRECT = True  # HTTPS強制
SECURE_HSTS_SECONDS = 31536000  # HSTS
SECURE_HSTS_INCLUDE_SUBDOMAINS = True
SECURE_HSTS_PRELOAD = True
SECURE_CONTENT_TYPE_NOSNIFF = True
SECURE_BROWSER_XSS_FILTER = True
X_FRAME_OPTIONS = 'DENY'
SECURE_REFERRER_POLICY = 'strict-origin-when-cross-origin'
```

---

# 7. ログと監査（Logging & Auditing）

## 7.1 ログ記録対象

- ログイン試行（成功・失敗）
- 認証エラー
- 権限エラー
- 重要な操作（プロジェクト作成・削除等）

## 7.2 ログ形式

```json
{
  "timestamp": "2024-01-01T00:00:00Z",
  "level": "INFO",
  "user_id": "uuid",
  "action": "login_success",
  "ip_address": "192.168.1.1"
}
```

## 7.3 機密情報の取り扱い

- パスワードはログに記録しない
- トークンはログに記録しない
- 個人情報はマスキング

---

# 8. エラーハンドリング

## 8.1 認証エラー

### 401 Unauthorized
- トークンが無効
- トークンが期限切れ
- トークンが未提供

### 403 Forbidden
- 権限不足
- アクセス拒否

## 8.2 エラーレスポンス形式

```json
{
  "error": "authentication_error",
  "message": "Invalid or expired token",
  "code": "AUTH_001"
}
```

---

# 9. 環境変数とシークレット管理

## 9.1 管理するシークレット

- `SECRET_KEY`: Django秘密鍵
- `JWT_SECRET_KEY`: JWT署名用秘密鍵
- `DATABASE_PASSWORD`: データベースパスワード
- `ALLOWED_HOSTS`: 許可ホスト

## 9.2 管理方法

- 環境変数で管理
- `.env` ファイル（開発環境）
- 本番環境は環境変数またはシークレット管理サービス

---

# 10. セキュリティチェックリスト

## 10.1 開発時

- [ ] HTTPSを強制
- [ ] CSRF保護を有効化
- [ ] XSS対策を実装
- [ ] SQLインジェクション対策（ORM使用）
- [ ] パスワードをハッシュ化
- [ ] レート制限を実装
- [ ] CORSを適切に設定
- [ ] セキュリティヘッダーを設定
- [ ] ログに機密情報を含めない

## 10.2 デプロイ時

- [ ] SSL証明書を設定
- [ ] 環境変数を設定
- [ ] セキュリティヘッダーを確認
- [ ] ログ設定を確認
- [ ] バックアップ設定を確認

---

# 11. 将来の拡張

## 11.1 多要素認証（MFA）
- TOTP（Time-based One-Time Password）
- SMS認証
- メール認証

## 11.2 OAuth 2.0連携
- Google認証
- GitHub認証
- その他SNS認証

## 11.3 セッション管理
- アクティブセッション一覧
- リモートログアウト機能

---

# 12. 備考

- 本仕様は MVP 版を前提とする
- 将来的な拡張（チーム共有、外部認証等）を考慮した設計
- セキュリティ要件は定期的に見直しを行う

