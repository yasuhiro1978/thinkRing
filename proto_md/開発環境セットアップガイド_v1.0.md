# 開発環境セットアップガイド（Development Environment Setup Guide）
## プロジェクト名：thinkRing
## バージョン：v1.0
## 作成者：yasuhiro

---

# 1. 概要（Overview）

本ガイドは、thinkRingアプリケーションの開発環境を構築する手順を説明する。  
Dockerを使用して環境を統一し、開発効率を向上させる。

---

# 2. 前提条件（Prerequisites）

## 2.1 必要なソフトウェア

### 必須
- **Docker**: 20.10以上
- **Docker Compose**: 2.0以上
- **Git**: 2.30以上
- **エディタ**: VS Code / Cursor 推奨

### 推奨
- **Node.js**: 18以上（フロントエンド開発用）
- **Python**: 3.10以上（ローカル開発用、オプション）

## 2.2 システム要件

- **OS**: macOS / Linux / Windows（WSL2推奨）
- **メモリ**: 8GB以上推奨
- **ディスク容量**: 10GB以上

---

# 3. リポジトリのクローン

```bash
# リポジトリをクローン
git clone https://github.com/your-org/thinkring.git
cd thinkring

# ブランチを確認
git branch
```

---

# 4. 環境変数の設定

## 4.1 環境変数ファイルの作成

### バックエンド用（.env.backend）

```bash
# Django設定
SECRET_KEY=your-secret-key-here
DEBUG=True
ALLOWED_HOSTS=localhost,127.0.0.1

# データベース設定
DB_NAME=thinkring_db
DB_USER=thinkring_user
DB_PASSWORD=thinkring_password
DB_HOST=db
DB_PORT=5432

# JWT設定
JWT_SECRET_KEY=your-jwt-secret-key-here
JWT_ACCESS_TOKEN_LIFETIME=15
JWT_REFRESH_TOKEN_LIFETIME=7

# CORS設定
CORS_ALLOWED_ORIGINS=http://localhost:3000,http://127.0.0.1:3000
```

### フロントエンド用（.env.frontend）

```bash
# API設定
VITE_API_BASE_URL=http://localhost:8000/api/v1
VITE_WS_URL=ws://localhost:8000
```

## 4.2 環境変数ファイルの配置

```bash
# プロジェクトルートに配置
cp .env.backend.example .env.backend
cp .env.frontend.example .env.frontend

# 環境変数を編集
# SECRET_KEY等を適切な値に変更
```

---

# 5. Docker環境の構築

## 5.1 Docker Composeファイルの確認

プロジェクトルートに `docker-compose.yml` があることを確認：

```yaml
version: '3.8'

services:
  db:
    image: postgres:15
    environment:
      POSTGRES_DB: thinkring_db
      POSTGRES_USER: thinkring_user
      POSTGRES_PASSWORD: thinkring_password
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"

  backend:
    build: ./backend
    command: python manage.py runserver 0.0.0.0:8000
    volumes:
      - ./backend:/app
    ports:
      - "8000:8000"
    depends_on:
      - db
    environment:
      - DEBUG=True

  frontend:
    build: ./frontend
    command: npm run dev
    volumes:
      - ./frontend:/app
    ports:
      - "3000:3000"
    depends_on:
      - backend

volumes:
  postgres_data:
```

## 5.2 Dockerコンテナの起動

```bash
# コンテナのビルドと起動
docker-compose up -d --build

# ログの確認
docker-compose logs -f

# コンテナの状態確認
docker-compose ps
```

---

# 6. データベースのセットアップ

## 6.1 マイグレーションの実行

```bash
# バックエンドコンテナに入る
docker-compose exec backend bash

# マイグレーションの実行
python manage.py migrate

# スーパーユーザーの作成（オプション）
python manage.py createsuperuser
```

## 6.2 初期データの投入（オプション）

```bash
# フィクスチャの読み込み
python manage.py loaddata initial_data.json
```

---

# 7. フロントエンドのセットアップ

## 7.1 依存関係のインストール

```bash
# フロントエンドコンテナに入る
docker-compose exec frontend bash

# 依存関係のインストール
npm install

# または yarn を使用する場合
yarn install
```

## 7.2 開発サーバーの起動

```bash
# 開発サーバーは既に起動している（docker-compose up で起動）
# 手動で起動する場合
npm run dev
```

---

# 8. 開発環境の確認

## 8.1 アクセステスト

### バックエンド
- URL: http://localhost:8000
- API: http://localhost:8000/api/v1/
- 管理画面: http://localhost:8000/admin/

### フロントエンド
- URL: http://localhost:3000

## 8.2 動作確認

```bash
# バックエンドのヘルスチェック
curl http://localhost:8000/api/v1/health/

# フロントエンドの確認
# ブラウザで http://localhost:3000 にアクセス
```

---

# 9. 開発ツールの設定

## 9.1 VS Code / Cursor設定

### 推奨拡張機能

- **Python**: Python開発用
- **ESLint**: JavaScript/TypeScriptのリント
- **Prettier**: コードフォーマット
- **Docker**: Dockerサポート

### 設定ファイル（.vscode/settings.json）

```json
{
  "python.defaultInterpreterPath": "/usr/local/bin/python3",
  "python.linting.enabled": true,
  "python.linting.pylintEnabled": true,
  "editor.formatOnSave": true,
  "editor.codeActionsOnSave": {
    "source.fixAll.eslint": true
  }
}
```

## 9.2 Git設定

```bash
# .gitignore の確認
# 環境変数ファイルやログファイルが除外されているか確認

# コミット前のチェック
git status
```

---

# 10. ローカル開発（Docker不使用）

## 10.1 バックエンドのローカル開発

### 仮想環境の作成

```bash
# Python仮想環境の作成
python3 -m venv venv

# 仮想環境の有効化
source venv/bin/activate  # macOS/Linux
# または
venv\Scripts\activate  # Windows

# 依存関係のインストール
pip install -r backend/requirements.txt
```

### データベースの設定

```bash
# PostgreSQLをローカルにインストール
# または Docker でデータベースのみ起動
docker-compose up -d db

# マイグレーションの実行
cd backend
python manage.py migrate
```

### 開発サーバーの起動

```bash
python manage.py runserver
```

## 10.2 フロントエンドのローカル開発

```bash
# 依存関係のインストール
cd frontend
npm install

# 開発サーバーの起動
npm run dev
```

---

# 11. トラブルシューティング

## 11.1 よくある問題

### ポートが既に使用されている

```bash
# ポートの使用状況を確認
lsof -i :8000  # macOS/Linux
netstat -ano | findstr :8000  # Windows

# 既存のプロセスを終了
kill -9 <PID>  # macOS/Linux
```

### Dockerコンテナが起動しない

```bash
# ログを確認
docker-compose logs backend
docker-compose logs frontend
docker-compose logs db

# コンテナを再起動
docker-compose restart

# 完全にクリーンアップして再起動
docker-compose down -v
docker-compose up -d --build
```

### データベース接続エラー

```bash
# データベースコンテナの状態確認
docker-compose ps db

# データベースコンテナのログ確認
docker-compose logs db

# データベースコンテナの再起動
docker-compose restart db
```

### マイグレーションエラー

```bash
# マイグレーション状態の確認
python manage.py showmigrations

# マイグレーションのリセット（注意：データが削除される）
python manage.py migrate --fake-initial
```

## 11.2 ログの確認方法

```bash
# 全コンテナのログ
docker-compose logs

# 特定のコンテナのログ
docker-compose logs backend
docker-compose logs frontend

# リアルタイムでログを確認
docker-compose logs -f backend
```

---

# 12. 開発ワークフロー

## 12.1 日常的な開発フロー

```bash
# 1. 最新のコードを取得
git pull origin main

# 2. コンテナを起動
docker-compose up -d

# 3. 開発作業

# 4. 変更をコミット
git add .
git commit -m "feat: 機能追加"

# 5. プッシュ
git push origin feature-branch
```

## 12.2 データベース変更時のフロー

```bash
# 1. モデルを変更
# backend/apps/*/models.py を編集

# 2. マイグレーションファイルを作成
python manage.py makemigrations

# 3. マイグレーションを適用
python manage.py migrate

# 4. マイグレーションファイルをコミット
git add backend/apps/*/migrations/
git commit -m "migration: テーブル変更"
```

---

# 13. テスト環境のセットアップ

## 13.1 テスト用データベース

```bash
# テストの実行
python manage.py test

# 特定のテストのみ実行
python manage.py test apps.projects.tests
```

## 13.2 フロントエンドのテスト

```bash
# ユニットテスト
npm run test

# E2Eテスト
npm run test:e2e
```

---

# 14. パフォーマンス最適化

## 14.1 開発時の最適化

```bash
# ホットリロードの有効化（デフォルトで有効）
# ファイル変更時に自動でリロード

# デバッグモードの確認
# DEBUG=True の場合は詳細なエラー情報が表示される
```

## 14.2 プロファイリング

```bash
# Django Debug Toolbar の使用（開発時のみ）
# クエリの最適化確認
```

---

# 15. 環境のクリーンアップ

## 15.1 Docker環境のクリーンアップ

```bash
# コンテナの停止と削除
docker-compose down

# ボリュームも含めて削除（データが消える）
docker-compose down -v

# イメージも削除
docker-compose down --rmi all
```

## 15.2 ローカル環境のクリーンアップ

```bash
# Python仮想環境の削除
rm -rf venv

# node_modulesの削除
rm -rf frontend/node_modules

# キャッシュのクリア
npm cache clean --force
```

---

# 16. 次のステップ

環境構築が完了したら、以下を確認：

1. ✅ バックエンドAPIが動作している
2. ✅ フロントエンドが表示される
3. ✅ データベースに接続できる
4. ✅ 開発ツールが設定されている

開発を開始する準備が整いました！

---

# 17. 備考

- 本ガイドは MVP 版を前提とする
- 環境によって手順が異なる場合は、適宜調整する
- 問題が発生した場合は、チームに相談する

