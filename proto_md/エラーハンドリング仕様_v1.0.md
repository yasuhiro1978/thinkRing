# エラーハンドリング仕様（Error Handling Specification）
## プロジェクト名：thinkRing
## バージョン：v1.0
## 作成者：yasuhiro

---

# 1. 概要（Overview）

本ドキュメントは、thinkRingアプリケーションのエラーハンドリング方針とエラーコード定義を記載する。  
ユーザーに分かりやすいエラーメッセージを提供し、開発者が問題を迅速に特定できるようにする。

---

# 2. エラーハンドリング原則

## 2.1 基本方針

- **ユーザーフレンドリー**: 技術的な詳細を避け、分かりやすいメッセージ
- **一貫性**: 同じエラーは同じメッセージとコード
- **ログ記録**: 開発者向けの詳細情報をログに記録
- **適切なHTTPステータスコード**: RESTful APIの原則に従う

## 2.2 エラーレスポンス形式

### 標準エラーレスポンス

```json
{
  "error": {
    "code": "ERR_001",
    "message": "ユーザーフレンドリーなメッセージ",
    "type": "validation_error",
    "details": {
      "field": "title",
      "reason": "タイトルは必須です"
    },
    "timestamp": "2024-01-01T00:00:00Z",
    "request_id": "req_123456789"
  }
}
```

---

# 3. HTTPステータスコード

## 3.1 使用するステータスコード

| コード | 意味 | 用途 |
|-------|------|------|
| 200 | OK | 成功 |
| 201 | Created | リソース作成成功 |
| 400 | Bad Request | リクエストが不正 |
| 401 | Unauthorized | 認証が必要 |
| 403 | Forbidden | 権限不足 |
| 404 | Not Found | リソースが見つからない |
| 409 | Conflict | 競合（例：重複データ） |
| 422 | Unprocessable Entity | バリデーションエラー |
| 429 | Too Many Requests | レート制限超過 |
| 500 | Internal Server Error | サーバーエラー |
| 503 | Service Unavailable | サービス利用不可 |

---

# 4. エラーコード定義

## 4.1 認証エラー（AUTH_XXX）

| コード | HTTP | メッセージ | 説明 |
|-------|------|-----------|------|
| AUTH_001 | 401 | 認証が必要です | トークンが未提供 |
| AUTH_002 | 401 | 認証トークンが無効です | トークンが無効 |
| AUTH_003 | 401 | 認証トークンの有効期限が切れています | トークン期限切れ |
| AUTH_004 | 401 | ログイン情報が正しくありません | ユーザー名/パスワード不一致 |
| AUTH_005 | 403 | このリソースにアクセスする権限がありません | 権限不足 |

## 4.2 バリデーションエラー（VAL_XXX）

| コード | HTTP | メッセージ | 説明 |
|-------|------|-----------|------|
| VAL_001 | 422 | 必須項目が入力されていません | 必須フィールドが空 |
| VAL_002 | 422 | 入力値の形式が正しくありません | 形式エラー（例：メールアドレス） |
| VAL_003 | 422 | 入力値が長すぎます | 最大長超過 |
| VAL_004 | 422 | 入力値が短すぎます | 最小長未満 |
| VAL_005 | 422 | 無効な値が入力されています | 値が不正 |

## 4.3 リソースエラー（RES_XXX）

| コード | HTTP | メッセージ | 説明 |
|-------|------|-----------|------|
| RES_001 | 404 | プロジェクトが見つかりません | プロジェクトが存在しない |
| RES_002 | 404 | 周が見つかりません | 周が存在しない |
| RES_003 | 404 | ステップが見つかりません | ステップが存在しない |
| RES_004 | 404 | ノードが見つかりません | ノードが存在しない |
| RES_005 | 409 | このプロジェクト名は既に使用されています | 重複エラー |

## 4.4 サーバーエラー（SRV_XXX）

| コード | HTTP | メッセージ | 説明 |
|-------|------|-----------|------|
| SRV_001 | 500 | サーバーでエラーが発生しました | 一般的なサーバーエラー |
| SRV_002 | 500 | データベースエラーが発生しました | DB接続エラー |
| SRV_003 | 503 | サービスを一時的に利用できません | メンテナンス中 |
| SRV_004 | 429 | リクエストが多すぎます。しばらく待ってから再試行してください | レート制限超過 |

## 4.5 ビジネスロジックエラー（BIZ_XXX）

| コード | HTTP | メッセージ | 説明 |
|-------|------|-----------|------|
| BIZ_001 | 400 | この操作は許可されていません | ビジネスルール違反 |
| BIZ_002 | 409 | この操作は競合しています | 同時更新の競合 |

---

# 5. エラーハンドリング実装

## 5.1 バックエンド（Django）

### カスタム例外クラス

```python
# backend/apps/core/exceptions.py
from rest_framework.exceptions import APIException
from rest_framework import status

class ValidationError(APIException):
    status_code = status.HTTP_422_UNPROCESSABLE_ENTITY
    default_detail = 'バリデーションエラーが発生しました'
    default_code = 'VAL_001'

class ResourceNotFoundError(APIException):
    status_code = status.HTTP_404_NOT_FOUND
    default_detail = 'リソースが見つかりません'
    default_code = 'RES_001'

class AuthenticationError(APIException):
    status_code = status.HTTP_401_UNAUTHORIZED
    default_detail = '認証が必要です'
    default_code = 'AUTH_001'
```

### グローバルエラーハンドラー

```python
# backend/apps/core/middleware.py
import logging
from rest_framework.views import exception_handler
from rest_framework.response import Response

logger = logging.getLogger(__name__)

def custom_exception_handler(exc, context):
    response = exception_handler(exc, context)
    
    if response is not None:
        custom_response_data = {
            'error': {
                'code': getattr(exc, 'default_code', 'SRV_001'),
                'message': str(exc.detail),
                'type': exc.__class__.__name__,
                'timestamp': timezone.now().isoformat(),
                'request_id': context.get('request_id', '')
            }
        }
        response.data = custom_response_data
        
        # ログ記録
        logger.error(
            f"Error: {exc.__class__.__name__} - {exc.detail}",
            extra={'request_id': context.get('request_id', '')}
        )
    
    return response
```

## 5.2 フロントエンド（Svelte/React）

### エラーハンドリングユーティリティ

```typescript
// frontend/src/utils/errorHandler.ts
interface ApiError {
  error: {
    code: string;
    message: string;
    type: string;
    details?: any;
    timestamp: string;
    request_id: string;
  };
}

export function handleApiError(error: ApiError): void {
  const errorCode = error.error.code;
  const errorMessage = error.error.message;
  
  // エラーコードに応じた処理
  switch (errorCode) {
    case 'AUTH_001':
    case 'AUTH_002':
    case 'AUTH_003':
      // ログイン画面にリダイレクト
      redirectToLogin();
      break;
    
    case 'VAL_001':
    case 'VAL_002':
      // バリデーションエラーを表示
      showValidationError(error.error.details);
      break;
    
    case 'RES_001':
      // 404エラーを表示
      showNotFoundError();
      break;
    
    default:
      // 一般的なエラーメッセージを表示
      showErrorMessage(errorMessage);
  }
  
  // エラーログを記録
  console.error('API Error:', error);
}
```

### トースト通知

```typescript
// frontend/src/utils/toast.ts
export function showErrorToast(message: string, code?: string): void {
  // トースト通知を表示
  toast.error(message, {
    duration: 5000,
    position: 'top-right',
  });
}
```

---

# 6. ログ記録

## 6.1 ログレベル

| レベル | 用途 |
|-------|------|
| DEBUG | 開発時の詳細情報 |
| INFO | 一般的な情報 |
| WARNING | 警告（処理は継続） |
| ERROR | エラー（処理が失敗） |
| CRITICAL | 重大なエラー |

## 6.2 ログ形式

```json
{
  "timestamp": "2024-01-01T00:00:00Z",
  "level": "ERROR",
  "logger": "thinkring.api",
  "message": "Resource not found",
  "error_code": "RES_001",
  "request_id": "req_123456789",
  "user_id": "user_123",
  "path": "/api/v1/projects/999",
  "method": "GET",
  "ip_address": "192.168.1.1"
}
```

## 6.3 ログ記録対象

- 認証エラー
- バリデーションエラー
- リソースエラー
- サーバーエラー
- 重要な操作（作成・更新・削除）

---

# 7. エラーメッセージの国際化（将来）

## 7.1 多言語対応

- 日本語（デフォルト）
- 英語（将来）

## 7.2 実装方針

```python
# backend/apps/core/messages.py
ERROR_MESSAGES = {
    'ja': {
        'AUTH_001': '認証が必要です',
        'VAL_001': '必須項目が入力されていません',
    },
    'en': {
        'AUTH_001': 'Authentication required',
        'VAL_001': 'Required field is missing',
    }
}
```

---

# 8. クライアント側エラーハンドリング

## 8.1 ネットワークエラー

```typescript
// ネットワークエラーの処理
try {
  const response = await fetch('/api/v1/projects');
} catch (error) {
  if (error instanceof TypeError) {
    // ネットワークエラー
    showErrorToast('ネットワークエラーが発生しました。接続を確認してください。');
  }
}
```

## 8.2 タイムアウト処理

```typescript
// タイムアウト設定
const controller = new AbortController();
const timeoutId = setTimeout(() => controller.abort(), 10000);

try {
  const response = await fetch('/api/v1/projects', {
    signal: controller.signal
  });
} catch (error) {
  if (error.name === 'AbortError') {
    showErrorToast('リクエストがタイムアウトしました。');
  }
} finally {
  clearTimeout(timeoutId);
}
```

---

# 9. エラー回復戦略

## 9.1 自動リトライ

```typescript
async function fetchWithRetry(url: string, retries = 3): Promise<Response> {
  for (let i = 0; i < retries; i++) {
    try {
      const response = await fetch(url);
      if (response.ok) {
        return response;
      }
    } catch (error) {
      if (i === retries - 1) throw error;
      await new Promise(resolve => setTimeout(resolve, 1000 * (i + 1)));
    }
  }
  throw new Error('Max retries exceeded');
}
```

## 9.2 フォールバック

- オフライン時はローカルストレージを使用
- エラー時はキャッシュされたデータを表示

---

# 10. エラー監視（将来）

## 10.1 エラー追跡ツール

- Sentry
- Rollbar
- Bugsnag

## 10.2 監視項目

- エラー発生率
- エラーコード別の発生頻度
- ユーザー影響範囲

---

# 11. エラーテスト

## 11.1 テストケース

- 認証エラーのテスト
- バリデーションエラーのテスト
- リソースエラーのテスト
- サーバーエラーのテスト

## 11.2 モックエラー

```python
# テストでのエラーモック
def test_authentication_error(client):
    response = client.get('/api/v1/projects', HTTP_AUTHORIZATION='invalid')
    assert response.status_code == 401
    assert response.json()['error']['code'] == 'AUTH_002'
```

---

# 12. エラーハンドリングチェックリスト

## 12.1 開発時

- [ ] すべてのエラーに適切なコードを設定
- [ ] ユーザーフレンドリーなメッセージを設定
- [ ] ログに詳細情報を記録
- [ ] 適切なHTTPステータスコードを使用
- [ ] エラーレスポンス形式を統一

## 12.2 デプロイ時

- [ ] 本番環境では機密情報をログに含めない
- [ ] エラーメッセージにスタックトレースを含めない
- [ ] エラー監視ツールを設定（将来）

---

# 13. 備考

- 本仕様は MVP 版を前提とする
- エラーコードは段階的に追加
- ユーザーフィードバックに基づいて改善

