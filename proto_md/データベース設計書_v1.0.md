# データベース設計書（Database Design Specification）
## プロジェクト名：thinkRing
## バージョン：v1.0
## 作成者：yasuhiro

---

# 1. 概要（Overview）

本ドキュメントは、thinkRingアプリケーションのデータベース設計を定義する。  
PostgreSQLを使用し、Django ORMを通じてアクセスする。

---

# 2. ER図（Entity Relationship Diagram）

```
┌─────────────┐
│  Project    │
│─────────────│
│ id (PK)     │
│ title       │
│ status      │
│ createdAt   │
│ updatedAt   │
└──────┬──────┘
       │
       │ 1:N
       │
┌──────▼──────┐
│   Round     │
│─────────────│
│ id (PK)     │
│ projectId   │──FK──┐
│ roundNumber │      │
│ note        │      │
│ createdAt   │      │
└──────┬──────┘      │
       │             │
       │ 1:N         │
       │             │
┌──────▼──────┐      │
│ ProcessStep │      │
│─────────────│      │
│ id (PK)     │      │
│ projectId   │──FK──┤
│ roundId     │──FK──┘
│ stepType    │
│ content     │
│ createdAt   │
└──────┬──────┘
       │
       │ 1:N
       │
┌──────▼──────┐
│    Node     │
│─────────────│
│ id (PK)     │
│ projectId   │──FK──┐
│ roundId     │──FK──┤
│ stepId      │──FK──┤
│ title       │      │
│ context     │      │
│ createdAt   │      │
└──────┬──────┘      │
       │             │
       │ 1:N         │
       │             │
┌──────▼─────────────┴──┐
│      NodeLink          │
│────────────────────────│
│ id (PK)                │
│ fromNodeId (FK)         │
│ toNodeId (FK)           │
│ weight                  │
│ createdAt               │
└────────────────────────┘
```

---

# 3. テーブル定義詳細（Table Definitions）

## 3.1 Project（プロジェクト）

### テーブル名
`projects`

### カラム定義

| カラム名 | 型 | 制約 | 説明 |
|---------|-----|------|------|
| id | UUID | PRIMARY KEY, NOT NULL | プロジェクトID |
| title | VARCHAR(255) | NOT NULL | プロジェクト名 |
| status | VARCHAR(20) | NOT NULL, DEFAULT 'active' | 状態（active/pending/completed） |
| createdAt | TIMESTAMP | NOT NULL, DEFAULT NOW() | 作成日時 |
| updatedAt | TIMESTAMP | NOT NULL, DEFAULT NOW() | 更新日時 |

### インデックス
- `idx_projects_status` ON `status`
- `idx_projects_created_at` ON `createdAt`

### 制約
- `status` は 'active', 'pending', 'completed' のいずれか

---

## 3.2 Round（周）

### テーブル名
`rounds`

### カラム定義

| カラム名 | 型 | 制約 | 説明 |
|---------|-----|------|------|
| id | UUID | PRIMARY KEY, NOT NULL | 周ID |
| projectId | UUID | FOREIGN KEY, NOT NULL | プロジェクトID |
| roundNumber | INTEGER | NOT NULL | 周番号（1〜5） |
| note | TEXT | NULL | 「なんか思いついた？」の回答 |
| createdAt | TIMESTAMP | NOT NULL, DEFAULT NOW() | 作成日時 |

### 外部キー
- `projectId` → `projects.id` (ON DELETE CASCADE)

### インデックス
- `idx_rounds_project_id` ON `projectId`
- `idx_rounds_project_round` ON (`projectId`, `roundNumber`)

### 制約
- `roundNumber` は 1〜5 の範囲
- 同一プロジェクト内で `roundNumber` は一意

---

## 3.3 ProcessStep（思考プロセスのステップ）

### テーブル名
`process_steps`

### カラム定義

| カラム名 | 型 | 制約 | 説明 |
|---------|-----|------|------|
| id | UUID | PRIMARY KEY, NOT NULL | ステップID |
| projectId | UUID | FOREIGN KEY, NOT NULL | プロジェクトID |
| roundId | UUID | FOREIGN KEY, NOT NULL | 周ID |
| stepType | VARCHAR(20) | NOT NULL | ステップ種別 |
| content | TEXT | NOT NULL | ステップ内容 |
| createdAt | TIMESTAMP | NOT NULL, DEFAULT NOW() | 作成日時 |

### 外部キー
- `projectId` → `projects.id` (ON DELETE CASCADE)
- `roundId` → `rounds.id` (ON DELETE CASCADE)

### インデックス
- `idx_process_steps_project_id` ON `projectId`
- `idx_process_steps_round_id` ON `roundId`
- `idx_process_steps_round_step` ON (`roundId`, `stepType`)

### 制約
- `stepType` は 'overview', 'extract', 'flow', 'mvp', 'expand' のいずれか
- 同一周内で `stepType` は一意

---

## 3.4 Node（ノード：カード＋文脈）

### テーブル名
`nodes`

### カラム定義

| カラム名 | 型 | 制約 | 説明 |
|---------|-----|------|------|
| id | UUID | PRIMARY KEY, NOT NULL | ノードID |
| projectId | UUID | FOREIGN KEY, NULL | プロジェクトID（グローバルノードはNULL） |
| roundId | UUID | FOREIGN KEY, NULL | 周ID |
| stepId | UUID | FOREIGN KEY, NULL | ステップID |
| title | VARCHAR(255) | NOT NULL | ノードタイトル（カード名） |
| context | TEXT | NULL | 文脈（周辺キーワード） |
| createdAt | TIMESTAMP | NOT NULL, DEFAULT NOW() | 作成日時 |

### 外部キー
- `projectId` → `projects.id` (ON DELETE CASCADE, NULL許可)
- `roundId` → `rounds.id` (ON DELETE CASCADE, NULL許可)
- `stepId` → `process_steps.id` (ON DELETE CASCADE, NULL許可)

### インデックス
- `idx_nodes_project_id` ON `projectId`
- `idx_nodes_round_id` ON `roundId`
- `idx_nodes_step_id` ON `stepId`
- `idx_nodes_title` ON `title` (部分インデックス、検索用)

### 制約
- `projectId` が NULL の場合、グローバルノードとして扱う
- `title` は必須

---

## 3.5 NodeLink（ノード間リンク）

### テーブル名
`node_links`

### カラム定義

| カラム名 | 型 | 制約 | 説明 |
|---------|-----|------|------|
| id | UUID | PRIMARY KEY, NOT NULL | リンクID |
| fromNodeId | UUID | FOREIGN KEY, NOT NULL | 元ノードID |
| toNodeId | UUID | FOREIGN KEY, NOT NULL | 先ノードID |
| weight | DECIMAL(3,1) | NOT NULL, DEFAULT 0.5 | 重み（0.1〜1.0） |
| createdAt | TIMESTAMP | NOT NULL, DEFAULT NOW() | 作成日時 |

### 外部キー
- `fromNodeId` → `nodes.id` (ON DELETE CASCADE)
- `toNodeId` → `nodes.id` (ON DELETE CASCADE)

### インデックス
- `idx_node_links_from_node` ON `fromNodeId`
- `idx_node_links_to_node` ON `toNodeId`
- `idx_node_links_bidirectional` ON (`fromNodeId`, `toNodeId`) UNIQUE

### 制約
- `weight` は 0.1〜1.0 の範囲
- `fromNodeId` と `toNodeId` は異なる必要がある
- 同一の `fromNodeId` と `toNodeId` の組み合わせは一意

---

# 4. リレーション定義（Relationships）

## 4.1 Project → Round
- **関係**: 1対多（1つのプロジェクトに複数の周）
- **削除動作**: CASCADE（プロジェクト削除時、関連する周も削除）

## 4.2 Project → ProcessStep
- **関係**: 1対多（1つのプロジェクトに複数のステップ）
- **削除動作**: CASCADE

## 4.3 Project → Node
- **関係**: 1対多（1つのプロジェクトに複数のノード）
- **削除動作**: CASCADE
- **注意**: グローバルノードは `projectId` が NULL

## 4.4 Round → ProcessStep
- **関係**: 1対多（1つの周に複数のステップ）
- **削除動作**: CASCADE

## 4.5 Round → Node
- **関係**: 1対多（1つの周に複数のノード）
- **削除動作**: CASCADE

## 4.6 ProcessStep → Node
- **関係**: 1対多（1つのステップに複数のノード）
- **削除動作**: CASCADE

## 4.7 Node → NodeLink
- **関係**: 多対多（ノード間のリンク）
- **削除動作**: CASCADE（ノード削除時、関連リンクも削除）

---

# 5. データ型の詳細

## 5.1 UUID
- PostgreSQL の `uuid` 型を使用
- Django では `models.UUIDField(primary_key=True, default=uuid.uuid4)`

## 5.2 TIMESTAMP
- PostgreSQL の `TIMESTAMP WITH TIME ZONE` を使用
- タイムゾーン情報を含む

## 5.3 TEXT
- 長文テキスト用
- 制限なし（実用的には数MBまで）

## 5.4 DECIMAL
- `DECIMAL(3,1)` は 0.1〜1.0 の範囲を表現
- 小数点以下1桁

---

# 6. マイグレーション方針

## 6.1 初期マイグレーション
- 全テーブルの作成
- インデックスの作成
- 制約の設定

## 6.2 将来の拡張
- ユーザー認証テーブル（将来追加）
- チーム共有テーブル（将来追加）
- GraphDB連携用のビュー（将来追加）

## 6.3 命名規則
- テーブル名: スネークケース、複数形（例: `process_steps`）
- カラム名: スネークケース（例: `created_at`）
- インデックス名: `idx_{テーブル名}_{カラム名}`

---

# 7. パフォーマンス考慮事項

## 7.1 インデックス戦略
- 外部キーには必ずインデックスを設定
- 検索で使用するカラム（`title`, `status`）にインデックス
- 複合インデックスでクエリを最適化

## 7.2 クエリ最適化
- N+1問題を避けるため、`select_related` / `prefetch_related` を使用
- 大量データ取得時はページネーションを実装

## 7.3 データ量想定
- プロジェクト数: 100〜1000件/ユーザー
- ノード数: 500件/プロジェクト程度まで快適動作
- ノードリンク数: 1000件/プロジェクト程度

---

# 8. セキュリティ考慮事項

## 8.1 データ分離
- 将来的にユーザー認証を追加した場合、ユーザー単位でデータを分離

## 8.2 論理削除
- MVPでは物理削除を採用
- 将来、論理削除（`deletedAt` カラム）を追加可能な設計

## 8.3 データバックアップ
- 定期的なバックアップを想定
- PostgreSQL の `pg_dump` を使用

---

# 9. 備考

- 本設計は MVP 版を前提とする
- 将来的な拡張（ユーザー認証、チーム共有等）を考慮した設計
- Django ORM のモデル定義は別途作成する

